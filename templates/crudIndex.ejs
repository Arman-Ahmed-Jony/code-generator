<script setup>
import { use<%=entityName.replace(/\w/, c => c.toUpperCase())%>Store } from 'src/stores/<%=entityName %>-store'
import { computed, onMounted, ref } from 'vue'
import <%=entityName.replace(/\w/, c => c.toUpperCase()) %>Form from '../components/<%=entityName.replace(/\w/, c => c.toUpperCase())%>Form.vue'
import <%=entityName.replace(/\w/, c => c.toUpperCase()) %>List from '../components/<%=entityName.replace(/\w/, c => c.toUpperCase())%>List.vue'
import { useCommonStore } from 'src/stores/common-store'
import { useBackButton } from 'src/composables/backButton'
<% if(aditionals.includes('filter')) { %>
import HeaderAppend from 'src/global-components/HeaderAppend.vue'
import <%=entityName.replace(/\w/, c => c.toUpperCase()) %>Filter from '../components/<%=entityName.replace(/\w/, c => c.toUpperCase()) %>Filter.vue'
<% } %>
<% if(aditionals.includes('pagination')) { %>
import { useCriteria } from 'src/composables/criteria.js'
<% } %>

useBackButton()

const commonStore = useCommonStore()
const createDialog = ref(false)
const editDialog = ref(false)

const <%=entityName %>Store = use<%=entityName.replace(/\w/, c => c.toUpperCase())%>Store()
const <%=entityName %>s = computed(() => <%=entityName %>Store.<%=entityName %>s)



const handleCreate = async (data) => {
  try {
    await <%=entityName %>Store.create(data)
    createDialog.value = false
  } catch (error) {}
}

const handleView = (item) => {
  //here gose view related implementation
}

const selected<%=entityName.replace(/\w/, c => c.toUpperCase())%> = ref({})
const handleEdit = async (item) => {
  await <%=entityName %>Store.update(item.id, item)
  editDialog.value = false
}
const handleDelete = (id) => {
  <%=entityName %>Store.deleteById(id)
}

<% if(aditionals.includes('filter')) { %>
const handleFilter = (filter) => {
  criteria.value.query.filters = filter
  callApi()
}
<% } %>

<% if(aditionals.includes('pagination')) { %>
const { criteria, updateCriteria } = useCriteria({
  current: 1,
  max: 1,
  per_page: 10
})
const callApi = async (filterCliteria = {}) => {
  updateCriteria({ ...filterCliteria })
  return <%=entityName %>Store.getAll(criteria.value).then(({ per_page, total, last_page, from, to }) => {
    updateCriteria({ per_page, total, last_page, from, to, max: last_page })
  })
}
const handlePagination = (page) => {
  updateCriteria({ page })
  callApi()
}
onMounted(() => {
  callApi()
})

<% } else { %>
  onMounted(() => {
    <%=entityName %>Store.getAll()
  })
<%}%>
</script>
<template>
  <q-page padding>
    <% if(aditionals.includes('filter')) { %>
    <HeaderAppend>
      <<%=entityName.replace(/\w/, c => c.toUpperCase()) %>Filter @submit="handleFilter" />
    </HeaderAppend>
    <% } %>
    <content-loader :loading="commonStore.fetching">
      <<%=entityName.replace(/\w/, c => c.toUpperCase()) %>List
        v-model="<%=entityName %>s"
        @view="handleView"
        @edit="editDialog=true, selected<%=entityName.replace(/\w/, c => c.toUpperCase())%> = $event"
        @delete="handleDelete"
      />
    </content-loader>

    <q-page-sticky
      position="bottom-right"
      :offset="[18, 18]"
    >
      <q-btn
        rounded
        glossy
        icon="o_add"
        color="primary"
        padding="sm"
        size="lg"
        @click="createDialog = true"
      />
    </q-page-sticky>
    <% if(aditionals.includes('pagination')) { %>
    <div
      style="position: absolute; bottom:0; right:50%; transform: translate(50%);"
      class="q-pt-lg"
    >
      <q-pagination
        v-model="criteria.current"
        :max="criteria.max"
        flat
        @update:model-value="handlePagination"
        color="grey"
        active-color="primary"
        class="justify-center"
        :max-pages="4"
        :boundary-numbers="false"
      />
    </div>
    <% } %>

    <q-dialog v-model="createDialog">
      <q-card
        style="width: 700px;"
        class="q-pa-sm"
      >
        <<%=entityName.replace(/\w/, c => c.toUpperCase()) %>Form @submit="handleCreate">
          <template #action>
            <div class="row justify-end">
              <q-btn
                color="primary"
                label="Create"
                type="submit"
                no-caps
              />
            </div>
          </template>
        </<%=entityName.replace(/\w/, c => c.toUpperCase()) %>Form>
      </q-card>
    </q-dialog>
    <q-dialog v-model="editDialog">
      <q-card
        style="width: 700px;"
        class="q-pa-sm"
      >
        <<%=entityName.replace(/\w/, c => c.toUpperCase()) %>Form
          @submit="handleEdit"
          :model-value="selected<%=entityName.replace(/\w/, c => c.toUpperCase())%>"
        >
          <template #action>
            <div class="row justify-end">
              <q-btn
                color="primary"
                label="Edit"
                type="submit"
                no-caps
              />
            </div>
          </template>
        </<%=entityName.replace(/\w/, c => c.toUpperCase()) %>Form>
      </q-card>
    </q-dialog>
  </q-page>
</template>
